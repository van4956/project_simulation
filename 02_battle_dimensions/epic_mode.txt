### Epic mode для симуляций

#### 1) Состояние партии (структуры)

- **Колода:** 55 карт фракций + 1 случайная аномалия (как в Baseline).
    У синих 11 **различимых** карт со значениями: `[2,3,5,7,11,13,17,17,19,23,29]` (17 встречается дважды).
    У остальных фракций 11 **неразличимых** карт.

- **Руки игроков:** списки карт; для синих храним значение карты, для остальных — цвет.

- **Измерения (область каждого игрока):** по цветам считаем количество; для синих дополнительно храним список значений в каждом отряде (для сумм).

- **Сущности игроков (PLAYERS):** уникальные фракции на игроков.

- **Капитан Сила (красный):** у красного игрока есть флаг `captain_available=True` и объект `captain_on_board` с позицией, когда выложен.

- **Ауры Тьмы (фиолетовый):** в каждом Измерении отдельный счётчик/стек аур (целочисленное число карт ауры).


#### 2) Фазы хода (как в Baseline), но с дополнительными проверками

1. **Битва Измерений (все одновременно):**
    — играют только фракционные карты из рук (аномалии не кладём в центр).
    — победители по Спирали получают карту в своё Измерение, остальные — в Чёрную Дыру.
    — **После фазы** делаем проверки досрочной победы (см. ниже).

2. **Усиление (ходящий):**
    — кладёт 1 карту в любое Измерение **или**, если он красный и `captain_available`, **может** вместо карты выложить Капитана Силы в любое Измерение.
    — **После фазы** проверки досрочной победы.

3. **Перемещение/Аномалия (ходящий):**
    — как в Baseline (рандомно: перемещение 1 карты между Измерениями или розыгрыш аномалии).
    — **Ограничения Epic:**

    - Капитана Силы может двигать **только** владелец; на него не действует **Кротовая Нора**.

    - На Капитана **не действует** Чёрная Дыра.

    - Ауры Тьмы нельзя перемещать; на них не действует Кротовая Нора.
        — **После фазы** проверки досрочной победы.

4. **Атака (ходящий):**
    — как в Baseline: атака **из** своего Измерения; «свой цвет по своему цвету» — запрещено.
    — **Фиолетовые особенности:**

    - Если **фиолетовый отряд** побеждает **любой обычный отряд**: поверженная карта **не** в Чёрную Дыру, а превращается в **Ауру Тьмы** в этом же Измерении (рубашкой вверх).

    - Если побеждён **отряд Ауры Тьмы**: он теряет **1** карту ауры в Чёрную Дыру (Ауры — «нейтральные»; убирать по одной, как обычно).

    - **Фиолетовый не может атаковать Ауры Тьмы.**
        — **Капитан Силы** участвует как обычная красная карта в составе отряда (даёт +1 к размеру), **но не уничтожается**:

    - если красный отряд проиграл и должен «сбросить 1 карту», а в отряде есть Капитан, в сброс отправляется **обычная** красная карта; Капитан остаётся (если обычных нет — «штрафная потеря» игнорируется, Капитан остаётся один).
        — **После фазы** проверки досрочной победы.

5. **Восстановление (добор до 4):**
    — как в Baseline, с фиксацией игрока, взявшего последнюю карту → назначаем **один финальный ход** этого игрока.
    — **После добора** проверка досрочной победы (вдруг прилетел Большой Взрыв и вернул колоду — тогда всё по прежним правилам).


#### 3) Досрочные победы (Epic-условия) — проверяем **после каждой из 5 фаз**

- **Красный (Капитан Сила):** специальной «мгновенной» победы **нет**. Эффект — только как **+1 карта**, неуязвимая к Чёрной Дыре и внешним перемещениям.

- **Зелёный (Доспехи Бога):** если **в любом одном Измерении** количество **зелёных** карт `>= 5` → **немедленная победа зелёного**.

- **Жёлтый (Планеты-Споры):** если **во всех Измерениях** (во всех активных Измерениях, то есть если 3 игрока то в трех, если 4 игрока - в 4, если 5 - в 5 Измерениях) должно быть **минимум по 1 жёлтой** в каждом **и** суммарно **>= 5 жёлтых** по всем Измерениям → **немедленная победа жёлтого**.

- **Синий (Сверхразум):** если **в любом Измерении** существует **синий отряд**, у которого **сумма значений карт = 42**, → **немедленная победа синего**.
    (Список значений у синих карт: `[2,3,5,7,11,13,17,17,19,23,29]`.)

- **Фиолетовый (Ауры Тьмы):** мгновенной победы нет; механика — трансформация поверженных карт в Ауры и их учёт **в конце игры**.

> При возникновении **нескольких** условий одновременно (редко, но возможно): применяем приоритет «как встретили»: проверяем после каждой фазы в порядке R→G→Y→B→P или фиксируем первый триггер по времени и сразу завершаем партию. (Я бы выбрал «первый по времени срабатывания» — детерминированно и честно.)



#### 4) Конец игры (если нет досрочной победы)

- Как ты уточнил: когда колода опустела, игрок, взявший **последнюю** карту, делает **ровно один** финальный ход из 5 фаз. После этого — **подсчёт**.

- **Подсчёт по Epic:**

    1. Считаем карты на поле (включая Капитана как **+1 красную**).

    2. **Ауры Тьмы** в каждом Измерении прибавляем к **фиолетовым** (они не цвет, но идут в счёт фиолетовой фракции по правилам).

    3. Оставляем только фракции-участники (`PLAYERS`), выбираем максимум; при равенстве — тай-брейк по Спирали; если цикл — случайно среди претендентов (как в Baseline).


#### 5) Аномалии — взаимодействие с Epic

- **Чёрная Дыра:** не действует на Капитана; на обычные карты действует как обычно; если цель — фиолетовый отряд (с обычных карт), карты уходят в Чёрную Дыру (Ауры при этом **не** создаются, т.к. это не «победа фиолетовых в бою»). Ауры можно отправлять в Чёрную Дыру (если аномалия нацелена на них как «отряд» — считаем допустимым), но **Кротовая Нора** на Ауры не действует.

- **Кротовая Нора:** не действует на Капитана и Ауры; остальные отряды переносит целиком.

- **Квантовая запутанность:** только перестановка Спирали.

- **Большой Взрыв:** возвращает из Чёрной Дыры **все карты**, включая ауры? По правилам Аура — это «перевёрнутая карта» на поле; в сброс попадают **потери** ауры при атаках. Эти карты в Чёрной Дыре обычные, их можно вернуть (я верну их как **обычные цветные карты** в колоду).

- **Временная Петля:** даёт текущему игроку ещё один ход; если наложится с финальным ходом — применяем по порядку событий (сначала петля, потом, когда колода опустела и финал назначен — финальный ход последнего добиравшего).


#### 6) Атаки и Ауры — детали

- Цель атаки — **в том же Измерении**, другим цветом.

- **Победа** определяется как в Baseline: больше карт **или** преимущество по Спирали.

- **Фиолетовый → обычный отряд**: минус 1 карта у защитника → вместо сброса эта карта становится **+1 к Аурам** в этом Измерении.

- **Любой цвет (кроме фиолетового) → Ауры:** при победе у Аур минус 1 карта → она уходит в **Чёрную Дыру**.

- **Фиолетовый не может атаковать Ауры.**


#### 7) Статистика (условные вероятности)

- Как в обновлённом Baseline: считаем **условные** вероятности `wins[f] / participates[f]`, где `participates[f]` — число партий, где фракция была среди `PLAYERS`.

- Для N=5 `participates[f] = runs`, для N=3/4 — меньше.
