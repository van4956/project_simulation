Epic Tactics

0) База, которая не меняется
Состояние, аномалии, Спираль, финальный ход, досрочные победы (G/Y/B), Капитан Сила, Ауры Тьмы — всё как в твоём Epic mode.

Считаем условные вероятности, как раньше.

1) Общие принципы выбора действий
Не бить «свою» фракцию (фракцию твоей Сущности) и не ухудшать её позицию если есть альтернатива.

Бить самую многочисленную фракцию (кроме своей) по текущему тоталу на поле, где для фиолетовых считаем purple_total = purple + auras.

Если у тебя есть условие досрочной победы (G/Y/B) — все решения сначала пытаются собрать условие.

Если у соперника близко к досрочной — решения стараются помешать этому быстрее, чем преследовать общую «бить самую большую».

При равенстве вариантов — рандом.

2) Выбор карты в фазах
А. Фаза 1 — Битва Измерений (одновременная)
Для каждого игрока при выборе карты из руки:

Blue: если можно сыграть карту, которая с высокой вероятностью попадёт в нужное Измерение для суммы 42 (см. ниже про усиление/движение), приоритет синей; иначе — смотрим далее.

Green: приоритет зелёной (нужны зелёные на одном стеке).

Yellow: приоритет жёлтой (важно покрыть все Измерения).

Purple: если у себя мало целей в своём Измерении, приоритет не purple (чтобы не «пушить» свой стек там, где атаковать некого). Иначе — можно purple.

Red: нейтрально; если капитан уже выложен — красную можно чаще.

Если приоритетов нет — карта, которая по Спирали чаще побеждает цвета, которые игроки обычно кладут (эвристика: самый частый цвет по прошлым битвам/видимым стекам).

Технически: оставим простой эвристический скоринг карт (blue>green>yellow>… по контексту), с тией обращаемся к вероятности победы по текущей Спирали против видимых «частых» цветов.

Б. Фаза 2 — Усиление (ходящий кладёт 1 карту в любое Измерение ИЛИ красный выкладывает капитана)
Приоритеты:

Green (досрочная): класть зелёные в один выбранный стек (обычно своё Измерение). Всегда усиливаем крупнейший зелёный стек «свой».

Yellow (досрочная): сначала обеспечить покрытие (в каждом Измерении по ≥1 жёлтой). Кладём жёлтую туда, где её нет. Когда покрытие выполнено — добираем до суммы ≥5 (в любое Измерение).

Blue (досрочная): выбираем Измерение, где сумма синих < 42 и ближе всего к 42, и в руку выбираем значение, которое не превышает 42 и максимально приближает к 42; если можно сделать ровно 42 — делаем немедленно.

Purple: усиливаем purple там, где в своём Измерении больше чужих целей → повышаем шанс удачной атаки и генерации аур.

Red (Капитан): если капитан не выложен — выложить рано (например, с p≈0.8 на первом доступном усилении) в своё Измерение с самым большим стеком красных; иначе — класть обычные красные туда же.

В. Фаза 3 — Перемещение ИЛИ Аномалия
Решаем сначала: «есть ли выгодная/нужная аномалия для досрочной своей или контрдействия чужой?» Если да — играем аномалию. Иначе — перемещение.

Аномалии — приоритеты:

Black Hole:

Уничтожить зелёный стек 5+ (немедленно).

Уничтожить зелёный стек 4 (предотвратить 5).

Сбить жёлтое покрытие (выбить жёлтую из любого Измерения, где она одна; приоритет — у игрока-лидера по жёлтым).

Уничтожить синий стек
близкок
42
близкок42 (сумма 35–41).

Снести самого многочисленного соперника (по тоталу), с приоритетом не «своей» фракции.
Капитан неуязвим; ауры можно чистить (в сброс как aura_back).

Wormhole:

Перетащить свои карты для досрочной:

green → слить в один стек;

yellow → закинуть жёлтую в Измерение, где её нет;

blue → слить синие в один стек под 42;

Разорвать чужую досрочную: увести жёлтую из критичного Измерения; развалить зелёный стек (перевести его в другое Измерение); развести синие, если сумма близка к 42.
Капитан/Ауры — не цель для Wormhole.

Quantum Entanglement: попытаться переставить Спираль так, чтобы твой самый большой стек бил самый большой чужой стек (или защищался от него). Если не находим улучшения — пропускаем.

Big Bang: играть, когда у тебя в сбросе заметный пул твоего цвета/синих (например, ≥3) и у соперников сброс меньше (или когда нужна «вторая жизнь»), и ещё есть геймплей до финала. (Ауры из сброса не вернём — ок.)

Time Loop: всегда выгодно — берём.

Перемещение (если не аномалия):

Green: двигать зелёную в свой «главный» зелёный стек.

Yellow: если где-то нет покрытия — переместить жёлтую туда; иначе не критично.

Blue: переместить синюю в стек, где сумма ближе к 42 (не превышая). Если есть два стека — слить в один.

Purple: перетянуть к себе цель (любой чужой цвет) или подтянуть purple туда, где целей больше.

Red (Капитан): не двигаем, если нет острой нужды; капитан и так защищён от Black Hole/Wormhole.

Г. Фаза 4 — Атака (из своего Измерения)
Сначала легальность: атакующий/цель в твоём Измерении, разные цвета.

Оптимизация цели:

Предотвратить чужую досрочную:

ударить по зелёному стеку 4 (сбросить до 3),

ударить по жёлтому в Измерении, где жёлтая в единственном экземпляре (чтобы сорвать покрытие),

ударить по синим, если сумма близка к 42 (снять 1 карту).

Если (1) не применимо — бить самую многочисленную фракцию (кроме своей), считая purple+auras.

Фиолетовый атакующий: если бьём обычный отряд и выигрываем → карта цели превращается в ауру (не в сброс). Ауры не атакуем фиолетовыми.

Не ухудшать свою фракцию: если есть выбор атак/карт, выбираем тот, что не уменьшает наш тотал «по цепочке» (например, не вскрывает наш стек под контратаку).

Победа атаки — как в Epic: «больше по числу» ИЛИ преимущество по Спирали.

Д. Фаза 5 — Восстановление
Как раньше. Если колода кончилась — финальный ход того, кто взял последнюю карту.

3) Проверки досрочной победы
После каждой фазы (1–5) проверяем в порядке первого срабатывания:

Green: где-то green >= 5 → немедленно win Green.

Yellow: во всех Измерениях >=1 жёлтой и общая сумма жёлтых >=5 → win Yellow.

Blue: где-то sum(blue_values) == 42 → win Blue.
Красный/Фиолетовый — без мгновенного вин, как и прежде.

4) Подсчёт в конце (если без досрочной)
Как в Epic: считаем по цветам, капитан +1 к красным, ауры + к фиолетовым, тём же тай-брейк по Спирали среди участников.

5) Технические детали реализации
Минимальные изменения коду: оставляем все структуры/функции Epic; меняем только выборы в фазах:

battle: выбираем карту по приоритетам (вместо чистого рандома);

reinforcement: выбор цвета/измерения по приоритетам (и капитан с высокой вероятностью рано);

movement_or_anomaly: сначала попытка «умной» аномалии по списку выше; иначе перемещение по целям;

attack: выбор атакующего цвета и цели по списку «предотвратить досрочную → бить лидера → не бить своих».

Там, где требуется сравнение «близко к 42»/«к 5»/«к покрытию», используем простые пороги:

синий «опасен» при сумме 35–41; зелёный «опасен» на 4; жёлтый «опасен», если в каждом Измерении уже есть ≥1 (осталось добрать до 5 по сумме).